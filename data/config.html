<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ESP32 LED Config</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial; max-width: 400px; margin: auto; }
    label { display: block; margin-top: 10px; }
    input, select { width: 100%; padding: 5px; }
    button { margin-top: 15px; width: 100%; padding: 10px; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Cấu hình ESP32 LED Controller</h2>
    <button onclick="location.href='links.html'" style="margin-top:10px;width:100%;padding:8px;">Liên kết Show–Audio</button>
    <form id="configForm">
      <label>WiFi SSID: <input name="wifiSSID" required></label>
      <label>WiFi Password: <input name="wifiPass" type="password" placeholder="(unchanged to keep) "></label>
      <label>Địa chỉ IP: <input name="localIP" placeholder="192.168.1.50"></label>
      <label>Số output (universes): <input name="outputs" type="number" min="1" max="2" value="2"></label>
      <label>Start Universe (0–1): <input name="startUniverse" type="number" min="0" max="1" value="0"></label>
      <button type="submit">Lưu cấu hình</button>
    </form>
    <div id="msg"></div>
  </div>
  <div class="card">
    <h2>Cập nhật Firmware (OTA)</h2>
    <form id="otaForm">
      <input type="file" name="update" required accept=".bin">
      <button type="submit">Upload Firmware</button>
      <div id="otaProgress"><div id="otaBar"></div></div>
      <div id="otaMsg"></div>
    </form>
  </div>
  <script>
    // Load config
    fetch('/config').then(r=>r.json()).then(cfg=>{
      for(let k in cfg) if(document.querySelector(`[name=${k}]`)) document.querySelector(`[name=${k}]`).value = cfg[k];
    });
    document.getElementById('configForm').onsubmit = function(e){
      e.preventDefault();
      let fd = new FormData(this);
      fetch('/config', {method:'POST', body:fd})
        .then(r=>r.text()).then(msg=>{
          document.getElementById('msg').innerText = msg;
          alert('Lưu cấu hình thành công');
        });
    };
    // OTA upload
    document.getElementById('otaForm').onsubmit = function(e){
      e.preventDefault();
      let fd = new FormData(this);
      let xhr = new XMLHttpRequest();
      xhr.open('POST', '/update', true);
      xhr.upload.onprogress = function(e){
        if(e.lengthComputable){
          let percent = Math.round(e.loaded/e.total*100);
          document.getElementById('otaBar').style.width = percent+'%';
        }
      };
      xhr.onload = function(){
        document.getElementById('otaMsg').innerText = xhr.responseText;
        if(xhr.responseText.includes('OK')) setTimeout(()=>location.reload(), 3000);
      };
      xhr.onerror = function(){
        document.getElementById('otaMsg').innerText = 'Lỗi upload!';
      };
      xhr.send(fd);
    }
  </script>
</body>
</html>
